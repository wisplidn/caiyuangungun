(TraeAI-11) ~/个人文档/caiyuangungun [0] $ cd /Users/daishun/个人文档/caiyuangungun && python src/caiyua
ngungun/data/norm/tests/example_processor_service.py
2025-09-29 10:31:06 - numexpr.utils - INFO - Note: NumExpr detected 12 cores but "NUMEXPR_MAX_THREADS" not set, so enforcing safe limit of 8.
2025-09-29 10:31:06 - numexpr.utils - INFO - NumExpr defaulting to 8 threads.
2025-09-29 10:31:06 - __main__ - INFO - 开始运行ProcessorService完整测试套件
2025-09-29 10:31:06 - __main__ - INFO - ============================================================
2025-09-29 10:31:06 - __main__ - INFO - 
开始测试: 配置管理器集成
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - === 测试：配置管理器集成 ===
2025-09-29 10:31:06 - __main__ - INFO - ✓ 获取处理器配置成功
2025-09-29 10:31:06 - __main__ - INFO -   配置描述: 利润表数据专用清洗流程，包含行处理、列处理、质检和输出等完整步骤
2025-09-29 10:31:06 - __main__ - INFO - ✓ 获取处理流水线成功，共 13 个步骤
2025-09-29 10:31:06 - __main__ - INFO - ✓ 获取路径配置成功
2025-09-29 10:31:06 - __main__ - INFO -   输入路径: data/norm/income_statement/merged/income_y.parquet
2025-09-29 10:31:06 - __main__ - INFO -   输出路径: data/norm/income_statement/cleaned/income_y.parquet
2025-09-29 10:31:06 - __main__ - INFO - ✓ 配置管理器集成 测试通过
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - 
开始测试: 列出处理器
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - === 测试：列出所有可用处理器 ===
可用处理器列表 (共4个):
--------------------------------------------------------------------------------
名称: fin_bs_processor
描述: 资产负债表数据专用清洗流程
输入: data/norm/balancesheet/merged/balancesheet.parquet
输出: data/norm/balancesheet/cleaned/balancesheet.parquet
步骤: 4个
类别: 质检, 行处理, 输出处理
--------------------------------------------------------------------------------
名称: fin_cf_processor
描述: 现金流量表数据专用清洗流程
输入: data/norm/cashflow/merged/cashflow_y.parquet
输出: data/norm/cashflow/cleaned/cashflow_y.parquet
步骤: 5个
类别: 质检, 行处理, 输出处理
--------------------------------------------------------------------------------
名称: fin_indicator_processor
描述: 财务指标数据专用清洗流程
输入: data/norm/fina_indicator/merged/fina_indicator_vip.parquet
输出: data/norm/fina_indicator/cleaned/fina_indicator_vip.parquet
步骤: 5个
类别: 质检, 行处理, 输出处理
--------------------------------------------------------------------------------
名称: fin_is_processor
描述: 利润表数据专用清洗流程，包含行处理、列处理、质检和输出等完整步骤
输入: data/norm/income_statement/merged/income_y.parquet
输出: data/norm/income_statement/cleaned/income_y.parquet
步骤: 13个
类别: 质检, 列处理, 行处理, 输出处理
--------------------------------------------------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - ✓ 列出处理器功能正常
2025-09-29 10:31:06 - __main__ - INFO - ✓ 列出处理器 测试通过
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - 
开始测试: 获取处理器信息
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - === 测试：获取处理器详细信息 ===
2025-09-29 10:31:06 - __main__ - INFO - ✓ 获取处理器信息成功
2025-09-29 10:31:06 - __main__ - INFO -   处理器名称: fin_is_processor
2025-09-29 10:31:06 - __main__ - INFO -   描述: 利润表数据专用清洗流程，包含行处理、列处理、质检和输出等完整步骤
2025-09-29 10:31:06 - __main__ - INFO -   模块路径: caiyuangungun.data.norm.processors.financials.fin_is_processor
2025-09-29 10:31:06 - __main__ - INFO -   类名: FinISProcessor
2025-09-29 10:31:06 - __main__ - INFO -   流水线步骤数: 13
2025-09-29 10:31:06 - __main__ - INFO - ✓ 获取处理器信息 测试通过
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - 
开始测试: 执行fin_is_processor
2025-09-29 10:31:06 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:06 - __main__ - INFO - === 测试：执行 fin_is_processor ===
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理器: fin_is_processor
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 输入路径: /Users/daishun/个人文档/caiyuangungun/data/norm/income_statement/merged/income_y.parquet
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 输出路径: /Users/daishun/个人文档/caiyuangungun/data/norm/income_statement/cleaned/income_y.parquet
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 从配置文件加载处理器: fin_is_processor from caiyuangungun.data.norm.processors.financials.fin_is_processor
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 读取输入数据...
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 输入数据形状: (345685, 100)
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理流水线，共13个步骤
2025-09-29 10:31:06 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1: remove_empty_ts_code (行处理) - 剔除ts_code为空的行，确保每条记录都有有效的股票代码标识
2025-09-29 10:31:06 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始剔除ts_code为空的行
2025-09-29 10:31:07 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 剔除ts_code为空的行完成，原始行数: 345685, 剔除行数: 3565, 剩余行数: 342120
2025-09-29 10:31:07 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1完成: (345685, 100) -> (342120, 100), 耗时: 0.40秒
2025-09-29 10:31:07 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2: drop_columns_and_duplicates (行处理) - 剔除ebit列和ebitda列，然后对所有剩余列执行删除重复行操作，清理数据冗余
2025-09-29 10:31:07 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始剔除ebit和ebitda列，并删除重复行
2025-09-29 10:31:07 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 已剔除列: ['ebit', 'ebitda']
2025-09-29 10:31:08 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 删除重复行完成，原始行数: 342120, 删除行数: 5, 剩余行数: 342115
2025-09-29 10:31:08 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2完成: (342120, 100) -> (342115, 98), 耗时: 1.85秒
2025-09-29 10:31:08 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3: handle_duplicate_records (行处理) - 处理更新重复行：按ts_code、end_date、f_ann_date分组，检查重复情况。单条记录保留，两条记录检查update_flag是否为0-1组合并保留update_flag=1的记录，超过两条记录则报错
2025-09-29 10:31:08 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始处理更新重复行
2025-09-29 10:31:09 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 发现重复记录数量: 126528
2025-09-29 10:31:09 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 处理重复记录完成，最终行数: 278851
2025-09-29 10:31:09 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3完成: (342115, 98) -> (278851, 98), 耗时: 1.00秒
2025-09-29 10:31:09 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4: create_assets_impair_loss_fixed (列处理) - 创建资产减值损失修正列：如果end_date>=20190630，则等于assets_impair_loss；否则等于-1*assets_impair_loss。这是为了统一不同会计准则下的科目方向
2025-09-29 10:31:09 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始创建assets_impair_loss_fixed列
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - assets_impair_loss_fixed列创建完成
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4完成: (278851, 98) -> (278851, 99), 耗时: 0.12秒
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤5: create_credit_impa_loss_fixed (列处理) - 创建信用减值损失修正列：如果end_date>=20190630，则等于credit_impa_loss；否则等于-1*credit_impa_loss。这是为了统一不同会计准则下的科目方向
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始创建credit_impa_loss_fixed列
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - credit_impa_loss_fixed列创建完成
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤5完成: (278851, 99) -> (278851, 100), 耗时: 0.00秒
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤6: create_total_opcost_fixed (列处理) - 创建营业总成本修正列：如果total_opcost不为空则使用原值，否则计算total_cogs+credit_impa_loss_fixed+assets_impair_loss_fixed。确保营业总成本数据的完整性
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始创建total_opcost_fixed列
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - total_opcost_fixed列创建完成
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤6完成: (278851, 100) -> (278851, 101), 耗时: 0.00秒
2025-09-29 10:31:10 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤7: validate_total_revenue (质检) - 营业收入核对：筛选comp_type=1的记录，计算total_revenue-revenue-int_income-prem_earned-comm_income，检查绝对值误差大于5万的记录数量，超过总记录1%则报错
2025-09-29 10:31:10 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始营业收入核对
2025-09-29 10:31:11 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业收入核对结果: 有效记录数=272392, 误差>5.0万记录数=377, 误差率=0.0014
2025-09-29 10:31:11 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业收入核对通过
2025-09-29 10:31:11 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤7完成: (278851, 101) -> (278851, 104), 耗时: 1.06秒
2025-09-29 10:31:11 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤8: validate_total_opcost (质检) - 营业成本核对：筛选comp_type=1的记录，计算total_opcost_fixed-(oper_cost+int_exp+comm_exp+biz_tax_surchg+sell_exp+admin_exp+fin_exp+rd_exp)，检查绝对值误差大于5万的记录数量，超过总记录1%则报错
2025-09-29 10:31:11 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始营业成本核对
2025-09-29 10:31:12 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业成本核对结果: 有效记录数=270931, 误差>5.0万记录数=808, 误差率=0.0030
2025-09-29 10:31:12 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业成本核对通过
2025-09-29 10:31:12 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤8完成: (278851, 104) -> (278851, 107), 耗时: 1.06秒
2025-09-29 10:31:12 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤9: validate_operate_profit (质检) - 营业利润核对：筛选comp_type=1的记录，计算operate_profit-(total_revenue-total_opcost_fixed+fv_value_chg_gain+invest_income+assets_impair_loss_fixed+credit_impa_loss_fixed+asset_disp_income+oth_income+forex_gain+net_expo_hedging_benefits)，检查绝对值误差大于5万的记录数量，超过总记录1.5%则报错
2025-09-29 10:31:12 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始营业利润核对
2025-09-29 10:31:13 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业利润核对结果: 有效记录数=271971, 误差>5万记录数=1618, 误差率=0.0059
2025-09-29 10:31:13 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 营业利润核对通过
2025-09-29 10:31:13 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤9完成: (278851, 107) -> (278851, 112), 耗时: 1.07秒
2025-09-29 10:31:13 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤10: validate_net_income (质检) - 净利润核对：筛选comp_type=1的记录，计算operate_profit-non_oper_income-non_oper_exp-income_tax-n_income，检查绝对值误差大于5万的记录数量，超过总记录1%则报错
2025-09-29 10:31:13 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始净利润核对
2025-09-29 10:31:14 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 净利润核对结果: 有效记录数=272176, 误差>5万记录数=595, 误差率=0.0022
2025-09-29 10:31:14 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 净利润核对通过
2025-09-29 10:31:14 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤10完成: (278851, 112) -> (278851, 117), 耗时: 1.10秒
2025-09-29 10:31:14 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤11: validate_unique_records (质检) - 重复记录质检：检查ts_code+end_date+f_ann_date组合是否存在重复，如果存在重复记录则报错，确保数据的唯一性
2025-09-29 10:31:14 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始重复记录质检
2025-09-29 10:31:14 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 重复记录质检通过
2025-09-29 10:31:14 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤11完成: (278851, 117) -> (278851, 117), 耗时: 0.05秒
2025-09-29 10:31:14 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤12: rename_fixed_columns (输出处理) - 重命名修正列：将total_opcost_fixed、credit_impa_loss_fixed、assets_impair_loss_fixed三列去掉_fixed后缀，恢复为标准字段名
2025-09-29 10:31:14 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始重命名修正列
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 删除原始列: total_opcost
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 重命名列: total_opcost_fixed -> total_opcost
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 删除原始列: credit_impa_loss
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 重命名列: credit_impa_loss_fixed -> credit_impa_loss
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 删除原始列: assets_impair_loss
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 重命名列: assets_impair_loss_fixed -> assets_impair_loss
2025-09-29 10:31:15 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤12完成: (278851, 117) -> (278851, 114), 耗时: 1.52秒
2025-09-29 10:31:15 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤13: output_parquet_file (输出处理) - 按指定字段顺序输出parquet文件：包含ts_code、f_ann_date、end_date等41个标准字段，不涉及的字段将被丢弃，确保输出数据结构的一致性
2025-09-29 10:31:15 - caiyuangungun.data.norm.services.processor_service - INFO - 跳过output_parquet_file，将在主流程中处理
2025-09-29 10:31:15 - caiyuangungun.data.norm.services.processor_service - INFO - 处理流水线执行完成
2025-09-29 10:31:15 - caiyuangungun.data.norm.services.processor_service - INFO - 使用output_parquet_file方法保存结果到: /Users/daishun/个人文档/caiyuangungun/data/norm/income_statement/cleaned/income_y.parquet
2025-09-29 10:31:15 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 开始输出parquet文件
2025-09-29 10:31:16 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - parquet文件已输出到: /Users/daishun/个人文档/caiyuangungun/data/norm/income_statement/cleaned/income_y.parquet
2025-09-29 10:31:16 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 输出数据形状: (278851, 41)
2025-09-29 10:31:16 - caiyuangungun.data.norm.processors.financials.fin_is_processor - INFO - 输出字段数: 41
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 处理器执行成功: fin_is_processor
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 数据形状变化: (345685, 100) -> (278851, 41)
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 执行时间: 10.45秒
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 输出文件大小: 51.13MB
2025-09-29 10:31:16 - __main__ - INFO - ✓ fin_is_processor 执行成功
2025-09-29 10:31:16 - __main__ - INFO -   处理时间: 10.45秒
2025-09-29 10:31:16 - __main__ - INFO -   输入数据形状: (345685, 100)
2025-09-29 10:31:16 - __main__ - INFO -   输出数据形状: (278851, 41)
2025-09-29 10:31:16 - __main__ - INFO -   输出文件: /Users/daishun/个人文档/caiyuangungun/data/norm/income_statement/cleaned/income_y.parquet
2025-09-29 10:31:16 - __main__ - INFO -   输出文件大小: 51.13 MB
2025-09-29 10:31:16 - __main__ - INFO - ✓ 输出文件创建成功
2025-09-29 10:31:16 - __main__ - INFO - ✓ 执行fin_is_processor 测试通过
2025-09-29 10:31:16 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:16 - __main__ - INFO - 
开始测试: 执行fin_bs_processor
2025-09-29 10:31:16 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:16 - __main__ - INFO - === 测试：执行 fin_bs_processor ===
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理器: fin_bs_processor
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 输入路径: /Users/daishun/个人文档/caiyuangungun/data/norm/balancesheet/merged/balancesheet.parquet
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 输出路径: /Users/daishun/个人文档/caiyuangungun/data/norm/balancesheet/cleaned/balancesheet.parquet
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 从配置文件加载处理器: fin_bs_processor from caiyuangungun.data.norm.processors.financials.fin_bs_processor
2025-09-29 10:31:16 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - ERROR - 加载配置文件失败: [Errno 2] No such file or directory: '/Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json'
2025-09-29 10:31:16 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - FinBSProcessor初始化完成，配置文件: /Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json
2025-09-29 10:31:16 - caiyuangungun.data.norm.services.processor_service - INFO - 读取输入数据...
2025-09-29 10:31:17 - caiyuangungun.data.norm.services.processor_service - INFO - 输入数据形状: (389933, 164)
2025-09-29 10:31:17 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理流水线，共4个步骤
2025-09-29 10:31:17 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1: remove_empty_ts_code (行处理) - 剔除ts_code为空的行，确保每条记录都有有效的股票代码标识
2025-09-29 10:31:17 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 开始移除ts_code为空的行
2025-09-29 10:31:18 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 移除了3580行ts_code为空的数据，剩余386353行
2025-09-29 10:31:18 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1完成: (389933, 164) -> (386353, 164), 耗时: 0.81秒
2025-09-29 10:31:18 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2: handle_duplicate_records (行处理) - 处理更新重复行：按ts_code、end_date、f_ann_date分组，检查重复情况。单条记录保留，两条记录检查update_flag是否为0-1组合并保留update_flag=1的记录，如果是1-1组合则取ann_date最新的记录，超过两条记录则报错
2025-09-29 10:31:18 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 开始处理更新重复行
2025-09-29 10:31:18 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 发现重复记录数量: 229682
2025-09-29 10:31:19 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 处理重复记录完成，最终行数: 271512
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2完成: (386353, 164) -> (271512, 164), 耗时: 1.62秒
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3: validate_unique_records (质检) - 重复记录质检：检查ts_code+end_date+f_ann_date组合是否存在重复，如果存在重复记录则报错
2025-09-29 10:31:19 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 开始重复记录质检
2025-09-29 10:31:19 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 重复记录质检通过
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3完成: (271512, 164) -> (271512, 164), 耗时: 0.05秒
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4: output_parquet_file (输出处理) - 输出parquet文件，保留全部字段
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 跳过output_parquet_file，将在主流程中处理
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 处理流水线执行完成
2025-09-29 10:31:19 - caiyuangungun.data.norm.services.processor_service - INFO - 使用output_parquet_file方法保存结果到: /Users/daishun/个人文档/caiyuangungun/data/norm/balancesheet/cleaned/balancesheet.parquet
2025-09-29 10:31:19 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 开始输出parquet文件
2025-09-29 10:31:21 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - parquet文件已输出到: /Users/daishun/个人文档/caiyuangungun/data/norm/balancesheet/cleaned/balancesheet.parquet
2025-09-29 10:31:21 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 输出数据形状: (271512, 164)
2025-09-29 10:31:21 - caiyuangungun.data.norm.processors.financials.fin_bs_processor - INFO - 输出字段数: 164
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 处理器执行成功: fin_bs_processor
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 数据形状变化: (389933, 164) -> (271512, 164)
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 执行时间: 4.64秒
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 输出文件大小: 100.24MB
2025-09-29 10:31:21 - __main__ - INFO - ✓ fin_bs_processor 执行成功
2025-09-29 10:31:21 - __main__ - INFO -   处理时间: 4.64秒
2025-09-29 10:31:21 - __main__ - INFO -   输入数据形状: (389933, 164)
2025-09-29 10:31:21 - __main__ - INFO -   输出数据形状: (271512, 164)
2025-09-29 10:31:21 - __main__ - INFO -   输出文件: /Users/daishun/个人文档/caiyuangungun/data/norm/balancesheet/cleaned/balancesheet.parquet
2025-09-29 10:31:21 - __main__ - INFO -   输出文件大小: 100.24 MB
2025-09-29 10:31:21 - __main__ - INFO - ✓ 输出文件创建成功
2025-09-29 10:31:21 - __main__ - INFO - ✓ 执行fin_bs_processor 测试通过
2025-09-29 10:31:21 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:21 - __main__ - INFO - 
开始测试: 执行fin_cf_processor
2025-09-29 10:31:21 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:21 - __main__ - INFO - === 测试：执行 fin_cf_processor ===
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理器: fin_cf_processor
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 输入路径: /Users/daishun/个人文档/caiyuangungun/data/norm/cashflow/merged/cashflow_y.parquet
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 输出路径: /Users/daishun/个人文档/caiyuangungun/data/norm/cashflow/cleaned/cashflow_y.parquet
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 从配置文件加载处理器: fin_cf_processor from caiyuangungun.data.norm.processors.financials.fin_cf_processor
2025-09-29 10:31:21 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - ERROR - 加载配置文件失败: [Errno 2] No such file or directory: '/Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json'
2025-09-29 10:31:21 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - FinCFProcessor初始化完成，配置文件: /Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json
2025-09-29 10:31:21 - caiyuangungun.data.norm.services.processor_service - INFO - 读取输入数据...
2025-09-29 10:31:22 - caiyuangungun.data.norm.services.processor_service - INFO - 输入数据形状: (346886, 103)
2025-09-29 10:31:22 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理流水线，共5个步骤
2025-09-29 10:31:22 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1: remove_empty_ts_code (行处理) - 剔除ts_code为空的行，确保每条记录都有有效的股票代码标识
2025-09-29 10:31:22 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 开始移除ts_code为空的行
2025-09-29 10:31:22 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 移除了3679行ts_code为空的数据，剩余343207行
2025-09-29 10:31:22 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1完成: (346886, 103) -> (343207, 103), 耗时: 0.57秒
2025-09-29 10:31:22 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2: drop_columns_and_duplicates (行处理) - 剔除free_cashflow列，然后对所有列执行去重
2025-09-29 10:31:22 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 开始删除指定列并去重
2025-09-29 10:31:23 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 删除了列: ['free_cashflow']
2025-09-29 10:31:25 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 去重完成，删除了11行重复数据，剩余343196行
2025-09-29 10:31:25 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2完成: (343207, 103) -> (343196, 102), 耗时: 2.41秒
2025-09-29 10:31:25 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3: handle_duplicate_records (行处理) - 处理更新重复行：按ts_code、end_date、f_ann_date分组，检查重复情况。单条记录保留，两条记录检查update_flag是否为0-1组合并保留update_flag=1的记录，超过两条记录则报错
2025-09-29 10:31:25 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 开始处理更新重复行
2025-09-29 10:31:25 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 发现重复记录数量: 132624
2025-09-29 10:31:26 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 处理重复记录完成，最终行数: 276884
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3完成: (343196, 102) -> (276884, 102), 耗时: 1.05秒
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4: validate_unique_records (质检) - 重复记录质检：检查ts_code+end_date+f_ann_date组合是否存在重复，如果存在重复记录则报错
2025-09-29 10:31:26 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 开始重复记录质检
2025-09-29 10:31:26 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 重复记录质检通过
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4完成: (276884, 102) -> (276884, 102), 耗时: 0.05秒
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤5: output_parquet_file (输出处理) - 输出parquet文件，保留全部字段
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 跳过output_parquet_file，将在主流程中处理
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 处理流水线执行完成
2025-09-29 10:31:26 - caiyuangungun.data.norm.services.processor_service - INFO - 使用output_parquet_file方法保存结果到: /Users/daishun/个人文档/caiyuangungun/data/norm/cashflow/cleaned/cashflow_y.parquet
2025-09-29 10:31:26 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 开始输出parquet文件
2025-09-29 10:31:28 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - parquet文件已输出到: /Users/daishun/个人文档/caiyuangungun/data/norm/cashflow/cleaned/cashflow_y.parquet
2025-09-29 10:31:28 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 输出数据形状: (276884, 102)
2025-09-29 10:31:28 - caiyuangungun.data.norm.processors.financials.fin_cf_processor - INFO - 输出字段数: 102
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 处理器执行成功: fin_cf_processor
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 数据形状变化: (346886, 103) -> (276884, 102)
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 执行时间: 6.56秒
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 输出文件大小: 81.45MB
2025-09-29 10:31:28 - __main__ - INFO - ✓ fin_cf_processor 执行成功
2025-09-29 10:31:28 - __main__ - INFO -   处理时间: 6.56秒
2025-09-29 10:31:28 - __main__ - INFO -   输入数据形状: (346886, 103)
2025-09-29 10:31:28 - __main__ - INFO -   输出数据形状: (276884, 102)
2025-09-29 10:31:28 - __main__ - INFO -   输出文件: /Users/daishun/个人文档/caiyuangungun/data/norm/cashflow/cleaned/cashflow_y.parquet
2025-09-29 10:31:28 - __main__ - INFO -   输出文件大小: 81.45 MB
2025-09-29 10:31:28 - __main__ - INFO - ✓ 输出文件创建成功
2025-09-29 10:31:28 - __main__ - INFO - ✓ 执行fin_cf_processor 测试通过
2025-09-29 10:31:28 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:28 - __main__ - INFO - 
开始测试: 执行fin_indicator_processor
2025-09-29 10:31:28 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:28 - __main__ - INFO - === 测试：执行 fin_indicator_processor ===
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理器: fin_indicator_processor
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 输入路径: /Users/daishun/个人文档/caiyuangungun/data/norm/fina_indicator/merged/fina_indicator_vip.parquet
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 输出路径: /Users/daishun/个人文档/caiyuangungun/data/norm/fina_indicator/cleaned/fina_indicator_vip.parquet
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 从配置文件加载处理器: fin_indicator_processor from caiyuangungun.data.norm.processors.financials.fin_indicator_processor
2025-09-29 10:31:28 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - ERROR - 加载配置文件失败: [Errno 2] No such file or directory: '/Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json'
2025-09-29 10:31:28 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - FinIndicatorProcessor初始化完成，配置文件: /Users/daishun/个人文档/caiyuangungun/src/caiyuangungun/data/config/specialized_cleaning_pipeline_config.json
2025-09-29 10:31:28 - caiyuangungun.data.norm.services.processor_service - INFO - 读取输入数据...
2025-09-29 10:31:29 - caiyuangungun.data.norm.services.processor_service - INFO - 输入数据形状: (539737, 173)
2025-09-29 10:31:29 - caiyuangungun.data.norm.services.processor_service - INFO - 开始执行处理流水线，共5个步骤
2025-09-29 10:31:29 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1: remove_empty_ts_code (行处理) - 剔除ts_code为空的行，确保每条记录都有有效的股票代码标识
2025-09-29 10:31:29 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 开始移除ts_code为空的行
2025-09-29 10:31:30 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 移除了14569行ts_code为空的数据，剩余525168行
2025-09-29 10:31:30 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤1完成: (539737, 173) -> (525168, 173), 耗时: 1.13秒
2025-09-29 10:31:30 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2: drop_columns_and_duplicates (行处理) - 剔除fcff和fcfe列，然后对所有列执行去重
2025-09-29 10:31:30 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 开始删除指定列并去重
2025-09-29 10:31:31 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 删除了列: ['fcff', 'fcfe']
2025-09-29 10:31:39 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 去重完成，删除了0行重复数据，剩余525168行
2025-09-29 10:31:39 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤2完成: (525168, 173) -> (525168, 171), 耗时: 8.98秒
2025-09-29 10:31:39 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3: handle_duplicate_records (行处理) - 处理更新重复行：按ts_code、end_date、ann_date分组，检查重复情况。单条记录保留，两条记录检查update_flag是否为0-1组合并保留update_flag=1的记录，超过两条记录则报错，不用fanndate是因为财务指标数据源没有fanndate
2025-09-29 10:31:39 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 开始处理更新重复行
2025-09-29 10:31:40 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 发现重复记录数量: 480952
2025-09-29 10:31:42 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 处理重复记录完成，最终行数: 284688
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤3完成: (525168, 171) -> (284688, 171), 耗时: 2.62秒
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4: validate_unique_records (质检) - 重复记录质检：检查ts_code+end_date+ann_date组合是否存在重复，如果存在重复记录则报错
2025-09-29 10:31:42 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 开始重复记录质检
2025-09-29 10:31:42 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 重复记录质检通过
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤4完成: (284688, 171) -> (284688, 171), 耗时: 0.06秒
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 步骤5: output_parquet_file (输出处理) - 输出parquet文件，保留全部字段
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 跳过output_parquet_file，将在主流程中处理
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 处理流水线执行完成
2025-09-29 10:31:42 - caiyuangungun.data.norm.services.processor_service - INFO - 使用output_parquet_file方法保存结果到: /Users/daishun/个人文档/caiyuangungun/data/norm/fina_indicator/cleaned/fina_indicator_vip.parquet
2025-09-29 10:31:42 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 开始输出parquet文件
2025-09-29 10:31:46 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - parquet文件已输出到: /Users/daishun/个人文档/caiyuangungun/data/norm/fina_indicator/cleaned/fina_indicator_vip.parquet
2025-09-29 10:31:46 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 输出数据形状: (284688, 171)
2025-09-29 10:31:46 - caiyuangungun.data.norm.processors.financials.fin_indicator_processor - INFO - 输出字段数: 171
2025-09-29 10:31:46 - caiyuangungun.data.norm.services.processor_service - INFO - 处理器执行成功: fin_indicator_processor
2025-09-29 10:31:46 - caiyuangungun.data.norm.services.processor_service - INFO - 数据形状变化: (539737, 173) -> (284688, 171)
2025-09-29 10:31:46 - caiyuangungun.data.norm.services.processor_service - INFO - 执行时间: 17.69秒
2025-09-29 10:31:46 - caiyuangungun.data.norm.services.processor_service - INFO - 输出文件大小: 231.77MB
2025-09-29 10:31:47 - __main__ - INFO - ✓ fin_indicator_processor 执行成功
2025-09-29 10:31:47 - __main__ - INFO -   处理时间: 17.69秒
2025-09-29 10:31:47 - __main__ - INFO -   输入数据形状: (539737, 173)
2025-09-29 10:31:47 - __main__ - INFO -   输出数据形状: (284688, 171)
2025-09-29 10:31:47 - __main__ - INFO -   输出文件: /Users/daishun/个人文档/caiyuangungun/data/norm/fina_indicator/cleaned/fina_indicator_vip.parquet
2025-09-29 10:31:47 - __main__ - INFO -   输出文件大小: 231.77 MB
2025-09-29 10:31:47 - __main__ - INFO - ✓ 输出文件创建成功
2025-09-29 10:31:47 - __main__ - INFO - ✓ 执行fin_indicator_processor 测试通过
2025-09-29 10:31:47 - __main__ - INFO - ----------------------------------------
2025-09-29 10:31:47 - __main__ - INFO - 
============================================================
2025-09-29 10:31:47 - __main__ - INFO - 测试总结
2025-09-29 10:31:47 - __main__ - INFO - ============================================================
2025-09-29 10:31:47 - __main__ - INFO - 配置管理器集成: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 列出处理器: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 获取处理器信息: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 执行fin_is_processor: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 执行fin_bs_processor: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 执行fin_cf_processor: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 执行fin_indicator_processor: ✓ 通过
2025-09-29 10:31:47 - __main__ - INFO - 
总计: 7/7 个测试通过
2025-09-29 10:31:47 - __main__ - INFO - 🎉 所有测试通过！ProcessorService 功能正常
2025-09-29 10:31:47 - __main__ - INFO - 
🎯 测试结论: ProcessorService 已准备就绪，可以投入使用
2025-09-29 10:31:47 - __main__ - INFO - 💡 使用方法: 输入 'fin_is_processor' 即可直接输出最终的parquet文件
